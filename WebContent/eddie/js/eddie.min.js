var Eddie=function(options){function remove(a){var b=a.split(","),c=b[0],d=b[1];"false"===d?removeDiv(c):emptyDiv(c),removeScript(c),removeInstance(c)}function doTerminate(a){"httpworker"===a&&(settings.worker.terminate(),settings.worker=null,console.log("STOPPED HTTPWORKER"))}function removeDiv(a){var b=document.getElementById(a);null!==b&&b.parentNode.removeChild(b)}function emptyDiv(a){var b=document.getElementById(a);null!==b&&(b.innerHTML="")}function removeScript(a){$("#script_"+a).remove()}function removeInstance(a){}function putMsg(a,b){var c=b;try{var d=c.indexOf("(");if(d!==-1){var e=c.substring(0,d),f=c.substring(d+1,c.length-1);c={target:[{id:e,class:e}],content:f,originalMessage:b}}}catch(a){console.log("escaped: "+b)}b=c;document.getElementById(a);components[a]?components[a].putMsg(b):window[a+"_putMsg"](b)}function setCSS(a){var b=document.createElement("link");b.setAttribute("rel","stylesheet"),b.setAttribute("type","text/css"),b.setAttribute("href",a),document.getElementsByTagName("head")[0].appendChild(b)}function onWSOpen(a){console.log("WS OPEN "+settings.worker),wsactive=!0,delayresettime=6e4}function onWSClose(a){console.log("WS CLOSE"),wsactive=!1}function onWSError(a){console.log("WS Error")}function onWSMessage(a){parseResponse(a.data)}function setStyle(a){try{var c=a.substring(0,a.indexOf(",")),d=document.getElementsByTagName("head")[0],e=document.getElementsByTagName("style"),f=$("style#"+c);a=a.substring(a.indexOf(",")+1),0===f.length?(f=document.createElement("style"),f.type="text/css",f.setAttribute("id",c),e.styleSheet?f.styleSheet.cssText=a:f.appendChild(document.createTextNode(a)),d.appendChild(f)):f.html(a)}catch(a){var g=printStackTrace();console.error("eddie.js: "+a.message+"\n\n"+g.join("\n\n"))}}function removeStyle(a){$("style#"+a).remove()}function setScript(targetid,scriptbody){var oname=scriptbody.substring(0,100),pname=oname.split(" ");if(pname.length>2)try{if(void 0===scripttypes[pname[1]]){var script=document.createElement("script");script.type="text/javascript",script.text=scriptbody,script.id="script_"+targetid,document.body.appendChild(script),scripttypes[pname[1]]=targetid}var obj=eval(pname[1]);callvars[targetid.substring(1)]={targetid:targetid.substring(1)},callers[targetid.substring(1)]=obj}catch(a){console.log(a)}else script=document.createElement("script"),script.type="text/javascript",script.text=scriptbody,script.id="script_"+targetid,document.body.appendChild(script)}function setDivProperty(targetid,content){var div=document.getElementById(targetid);if(null!==div){var commands=content.split(",");for(i=0;i<commands.length;i++){var command=commands[i],eventtargets=command.split(":");switch(command=eventtargets[0]){case"draggable":if(eventtargets.length>1){var data=eval("("+content.substring(10)+")");$("#"+targetid).draggable(data)}else $("#"+targetid).draggable();break;case"undraggable":$("#"+targetid).draggable("disable");break;case"style":$("#"+targetid).css(eventtargets[1],eventtargets[2]);break;case"sound":self.makesound(content.substring(6));break;case"bind":for(j=1;j<eventtargets.length;j++)$("#"+targetid).bind(eventtargets[j],{etarget:eventtargets[j]},function(a){var b=a.data;if("INPUT"==this.tagName){var c=targetid+".value="+this.value;self.putLou("",targetid+"/"+b.etarget+"("+c+")")}else{c="clientX="+a.clientX+",clientY="+a.clientY,c+=",screenX="+a.screenX+",screenY="+a.screenY;var d=jQuery(a.srcElement),e=d.offset(),f=e.left,g=e.top,h=d.position(),i=h.left,j=h.top,k=d[0].clientWidth,l=d[0].clientHeight;c+=",elementWidth="+k,c+=",elementHeight="+l,c+=",elementOffsetTop="+g,c+=",elementOffsetLeft="+f,c+=",elementPositionTop="+j,c+=",elementPositionLeft="+i,self.putLou("",targetid+"/"+b.etarget+"("+c+")")}})}}}}function parseHtml(a,b){var c=JSON.parse(b),d=Mustache.render(c.template,c);$("#"+a).html(d)}function setTemplate(a,b){var c=JSON.parse(b);callvars[a]={template:c.template}}function doUpdate(a,b){var c=JSON.parse(b);c.targetid=a,callers[a].update(callvars[a],c)}function setSyncvars(a,b){var c=JSON.parse(b),d=callvars[a];for(var e in c)d[e]=c[e]}function doTranslateXY(a,b){var c=b.split(","),d=c[0],e=c[1];if(0!==d.indexOf("%")){var f=$("#"+a).parent();d=f.width()/100*d.substring(0,d.length-1)}if(0!==e.indexOf("%")){var g=$("#"+a).parent();e=g.height()/100*e.substring(0,e.length-1)}$("#"+a).css("transform","translate("+d+"px,"+e+"px)")}function setBind(a,b){var c=document.getElementById(a);if(0===b.indexOf("keypress"))$(document).keydown(function(a){9==event.which&&(a.preventDefault(),a.stopPropagation())}),$(document).keyup(function(c){map={},map.targetid=a,map.which=event.which,map.id=event.target.id;var d=b.split(",");if(d.length>1)for(var e=1;e<d.length;e++){var f=d[e],g=$("#"+f),h=$("input[name="+f+"]:checked").val();void 0!==h?map[f]=h:"INPUT"===g.prop("tagName")?map[f]=$("#"+f).val():map[f]=$("#"+f).val()}self.putLou("","event("+a+"/keypress,"+JSON.stringify(map)+")")});else if(0===b.indexOf("play")||0===b.indexOf("pause")||0===b.indexOf("ended")||0===b.indexOf("error"))$("#"+a).on(b,function(){var c={};c.targetid=a,c.currentTime=1e3*$("#"+a)[0].currentTime,c.playbackRate=$("#"+a)[0].playbackRate,c.buffered=$("#"+a)[0].buffered,c.autoplay=$("#"+a)[0].autoplay,c.loop=$("#"+a)[0].loop,self.putLou("","event("+a+"/"+b+","+JSON.stringify(c)+")")});else if(0===b.indexOf("track/"))trackers[a]=b.substring(6),0===b.indexOf("track/devicemotion")?window.addEventListener("devicemotion",function(a){var b=Math.round(a.rotationRate.alpha),c=Math.round(a.rotationRate.beta),d=Math.round(a.rotationRate.gamma);(Math.abs(b)>10||Math.abs(c)>10||Math.abs(d)>10)&&(trackervalues["screen/devicemotion_alpha"]=b,trackervalues["screen/devicemotion_beta"]=c,trackervalues["screen/devicemotion_gamma"]=d,trackervalues["screen/devicemotion_send"]="true")}):0===b.indexOf("track/mousemove")&&($("#"+a).mousemove(function(){var b=trackervalues[a+"/mousemove"],c=event.layerX/event.target.offsetWidth*100,d=event.layerY/event.target.offsetHeight*100,e=event.offsetX+","+event.offsetY+","+event.layerX+","+event.layerY+","+c+","+d;b!=e&&(trackervalues[a+"/mousemove"]=e,trackervalues[a+"/mousemove_send"]="true")}),$("#"+a).on("touchmove",function(){for(var b=trackervalues[a+"/mousemove"],c="",d=this.getBoundingClientRect(),e=0;e<event.touches.length;e++){var f=event.touches[e],g=f.pageY-d.top,h=f.pageX-d.left;if(0===e){var i=h/window.innerWidth*100,j=g/window.innerHeight*100;c+=h+","+g+","+h+","+g+","+i+","+j}else c+=","+h+","+g+","+h+","+g+","+i+","+j}b!=c&&(trackervalues[a+"/mousemove"]=c,trackervalues[a+"/mousemove_send"]="true"),event.preventDefault()}));else if(null!==c){var d=b.split(":");for(j=0;j<d.length;j++){var e=d[j].split(",");$("#"+a).bind(e[0],{etarget:d[j]},function(b){var c=b.data;sendBasicEvent(a,this,c,b)})}}else{var d=b.split(":");for(j=0;j<d.length;j++){var e=d[j].split(",");$("."+a).bind(e[0],{etarget:d[j]},function(b){var c=b.data;sendBasicEvent(a,this,c,b)})}}}function sendBasicEvent(a,b,c,d){if("INPUT"===b.tagName){var e={};e[a+".value"]=b.value,e.value=b.value,e.id=d.target.id,self.putLou("","event("+a+"/"+c.etarget+","+JSON.stringify(e)+")")}else if("SELECT"===b.tagName){var e={};e.value=b.value,e.id=d.target.id,self.putLou("","event("+a+"/"+c.etarget+","+JSON.stringify(e)+")")}else{var f=c.etarget.split(",");e={},e.targetid=a,e.clientX=d.clientX,e.clientY=d.clientY,e.screenX=d.screenX,e.screenY=d.screenY;var g=d.clientX/window.innerWidth*100,h=d.clientY/window.innerHeight*100;if(e.screenXP=g,e.screenYP=h,f.length>1)for(var i=1;i<f.length;i++){var j=f[i],k=$("#"+j),l=$("input[name="+j+"]:checked").val();if(void 0!==l)e[j]=l;else if("INPUT"===k.prop("tagName"))if("file"===k.prop("type")){var m=$("#"+j);input=m[0],file=input.files[0];var n="?targetid="+j+"&screenid="+settings.screenId+"&cfilename="+file.name;reader=new FileReader,reader.readAsDataURL(file),reader.onload=function(a){file.data=a.target.result,self.doRequest({type:"POST",url:"http://"+settings.lou_ip+":"+settings.lou_port+"/lou/LouServlet"+settings.fullapp+n,data:file.data,dataType:"data",processData:!1,contentType:"application/data",async:!0})},e.filename=file.name,e[j]="filehandle"}else e[j]=$("#"+j).val();else e[j]=$("#"+j).val()}var o=jQuery(d.srcElement),p=o.offset();if(void 0!==p){var q=p.left,r=p.top;e.elementOffsetTop=r,e.elementOffsetLeft=q}var s=o.position();if(void 0!==s){var t=s.left,u=s.top;e.elementPositionTop=u,e.elementPositionLeft=t}if(void 0!==o[0]){var v=o[0].clientWidth,w=o[0].clientHeight;e.elementWidth=v,e.elementHeight=w}e.id=d.target.id,self.putLou("","event("+a+"/"+f[0]+","+JSON.stringify(e)+")")}}function simpleKeys(a){return Object.keys(a).reduce(function(b,c){return b[c]="object"==typeof a[c]?"{ ... }":a[c],b},{})}function setDiv(a,b){var c=document.getElementById(a);null!==c?$("#"+a).html(b):(c=document.createElement("div"),c.setAttribute("id",a),c.innerHTML=b,document.getElementById("screen").appendChild(c))}function addToDiv(a,b){var c=document.getElementById(a);null!==c&&(ne=document.createElement("div"),ne.innerHTML=b,c.appendChild(ne))}function getCapabilities(){var a="";a+="<platform>"+navigator.platform+"</platform>",a+="<appcodename>"+navigator.appCodeName+"</appcodename>",a+="<appname>"+navigator.appName+"</appname>",a+="<appversion>"+navigator.appVersion+"</appversion>",a+="<useragent>"+navigator.userAgent+"</useragent>",a+="<cookiesenabled>"+navigator.cookieEnabled+"</cookiesenabled>",a+="<screenwidth>"+window.innerWidth+"</screenwidth>",a+="<screenheight>"+window.innerHeight+"</screenheight>",a+="<orientation>"+window.orientation+"</orientation>",a+="<documenturl>"+location.hostname+"</documenturl>";var b=readCookie("smt_browserid");if(null===b){var c=""+(new Date).getTime();createCookie("smt_browserid",c,365)}b=readCookie("smt_browserid"),a+="<smt_browserid>"+b+"</smt_browserid>";var d=document.URL;d=d.substring(d.indexOf("/domain/")+8),d=d.substring(0,d.indexOf("?")),d=d.replace(/\//g,"_"),d="";var e=readCookie("smt_"+d+"_sessionid");return null===e&&(c=""+(new Date).getTime(),createCookie("smt_"+d+"_sessionid",c,365)),e=readCookie("smt_"+d+"_sessionid"),a+="<smt_sessionid>"+e+"</smt_sessionid>"}function createCookie(a,b,c){var d;if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d="; expires="+e.toGMTString()}else d="";document.cookie=escape(a)+"="+escape(b)+d+"; path=/"}function readCookie(a){for(var b=escape(a)+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b))return unescape(e.substring(b.length,e.length))}return null}function getPosition(a){trackervalues["screen/location"]=""+a.coords.latitude+","+a.coords.longitude}function eraseCookie(a){createCookie(a,"",-1)}function addGestureEvents(){window.addEventListener("orientationchange",function(){self.putLou("","orientationchange("+window.orientation+")")},!1)}var self={},callers={},callvars={},trackers={},trackervalues={},scripttypes={},websocket=null,wsactive=!1,delayresettime=5e3,settings={lou_ip:"",lou_port:"",app:"",fullapp:"",postData:'<fsxml><screen><properties><screenId>-1</screenId></properties><capabilities id="1"><properties>'+getCapabilities()+"</properties></capabilities></screen></fsxml>",screenId:"",timeoffset:-1,active:!0,appparams:null,worker_location:"/eddie/js/eddie_worker.js",worker:null,wsworker_location:"/eddie/js/eddie_wsworker.js",wsworker:null};$.extend(settings,options),settings.lou_port=""===window.location.port?"80":window.location.port,self.init=function(){responsetime=(new Date).getTime(),"undefined"!=typeof Worker?settings.worker=new Worker(settings.worker_location):console.log("Worker not supported"),$(self).on("register-success",self.listen),register(),addGestureEvents(),interval=setInterval(function(){nowdate=(new Date).getTime(),delaydate=nowdate-responsetime,delaydate>delayresettime&&(clearInterval(interval),window.location.href=window.location.href);for(var a in trackers){var b={},c=a,d=trackers[a].split(",");for(i=0;i<d.length;i++){var e=d[i],f=e.split("(");if($("#"+c).length)switch(f[0]){case"vars":var g=f[1].substring(0,f[1].length-1),h=callvars[c],j=trackervalues[c+"/"+e],k=h[g];j!=k&&(trackervalues[c+"/"+e]=k,b[g]=k);break;case"screenXPerc":var l=$("#"+c).position(),j=trackervalues[c+"/"+e],k=l.left/window.innerWidth*100;j!=k&&(trackervalues[c+"/"+e]=k,b.screenXPerc=k);break;case"screenYPerc":l=$("#"+c).position(),j=trackervalues[c+"/"+e],k=l.top/window.innerHeight*100,j!=k&&(trackervalues[c+"/"+e]=k,b.screenYPerc=k);break;case"mousemove":var m=trackervalues[c+"/"+e+"_send"];"true"===m&&(trackervalues[c+"/"+e+"_send"]="false",parts=trackervalues[c+"/"+e].split(","),b.screenX=parseFloat(parts[0]),b.screenY=parseFloat(parts[1]),b.clientX=parseFloat(parts[2]),b.clientY=parseFloat(parts[3]),b.screenXP=parseFloat(parts[4]),b.screenYP=parseFloat(parts[5]),b.clientXY=trackervalues[c+"/"+e],b.width=$("#"+c).width(),b.height=$("#"+c).height());break;case"devicemotion":var m=trackervalues["screen/devicemotion_send"];"true"===m&&(trackervalues["screen/devicemotion_send"]="false",b.alpha=trackervalues["screen/devicemotion_alpha"],b.beta=trackervalues["screen/devicemotion_beta"],b.gamma=trackervalues["screen/devicemotion_gamma"]);break;case"location":navigator.geolocation.getCurrentPosition(getPosition),k=trackervalues["screen/location"],j=trackervalues["screen/location_old"],j!=k&&(trackervalues[c+"/location_old"]=k,b.location=k,console.log("gps info="+k));break;case"currentTime":k=$("#"+c)[0].currentTime,j=trackervalues[c+"/"+e],j!=k&&(trackervalues[c+"/"+e]=k,b.currentTime=1e3*k)}}var n=JSON.stringify(b);"{}"!=n&&self.putLou("","event("+c+"/client,"+n+")")}},30)},self.getTimeOffset=function(){return settings.timeoffset},self.destroy=function(){var a=settings.screenId.split("/");self.putLou("notification","show(user "+a[a.length-1]+" left session!)");var b="stop("+settings.screenId+")";self.doRequest({type:"POST",url:"http://"+settings.lou_ip+":"+settings.lou_port+"/lou/LouServlet"+settings.fullapp,data:b,dataType:"text",async:!1})},self.doRequest=function(a){$.ajax(a)},self.sendEvent=function(a,b,c){c.eventtype=b,self.putLou("","event("+a+"/client,"+JSON.stringify(c)+")")},self.getComponent=function(a){return components[a]},self.listen=function(){settings.worker?(settings.worker.postMessage(JSON.stringify({fn:"init",args:{lou_ip:settings.lou_ip,lou_port:settings.lou_port,screenId:settings.screenId}})),settings.worker.onmessage=function(a){parseResponse(a.data)}):($(self).on("request-success",function(a,b){if(settings.active){try{parseResponse(b)}catch(a){console.log(a)}request()}}),request())},self.getScreenId=function(){return settings.screenId},self.log=function(a){return self.putLou("","log("+a+",info)"),!1},self.getVars=function(a){return callvars[a]},self.log=function(a,b){return self.putLou("","log("+a+","+b+")"),!1},self.putLou=function(a,b,c){var d="put("+settings.screenId+","+a+")="+b;return wsactive===!1?(console.log("send http data"),self.doRequest({type:"POST",url:"http://"+settings.lou_ip+":"+settings.lou_port+"/lou/LouServlet"+settings.fullapp,contentType:"text/plain",data:d,dataType:"text",async:!c})):websocket.send(d),!1},self.makesound=function(a){var b=new Audio("/eddie/sounds/"+a+".mp3");b.play()};var register=function(){var a=function(a){settings.screenId=$(a).find("screenid").first().text();var b=parseInt($(a).find("servertime").first().text());settings.timeoffset=(new Date).getTime()-b,$(self).trigger("register-success")};self.doRequest({type:"POST",url:"http://"+settings.lou_ip+":"+settings.lou_port+"/lou/LouServlet"+settings.fullapp+"?"+settings.appparams,data:settings.postData,success:a})},request=function(){var a="<fsxml><screen><properties><screenId>"+settings.screenId+"</screenId></properties></screen></fsxml>",b=settings.screenId.substring(0,settings.screenId.indexOf("/1/screen"));self.doRequest({type:"POST",url:"http://"+settings.lou_ip+":"+settings.lou_port+"/lou/LouServlet"+b,data:a,dataType:"text",contentType:"text/plain",success:function(a){$(self).trigger("request-success",a)}})},parseResponse=function(a){responsetime=(new Date).getTime();var b=a;if(b.indexOf("<screenid>appreset</screenid>")!=-1&&console.log("server reset"),null===websocket){var c="ws://"+settings.lou_ip+":"+settings.lou_port+"/lou/ws?screenid="+settings.screenId;websocket=new WebSocket(c),websocket.onopen=function(a){onWSOpen(a)},websocket.onclose=function(a){onWSClose(a)},websocket.onmessage=function(a){onWSMessage(a)},websocket.onerror=function(a){onWSError(a)}}for(var d=b.indexOf("(");d!=-1;){var e=b.substring(0,d);b=b.substring(d+1),d=b.indexOf(")");var f=b.substring(0,d);switch(e){case"set":var g=b.substring(d+2);d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),setDiv(f,g);break;case"val":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$("#"+f).val(g);break;case"html":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$("#"+f).html(g);break;case"location":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),window.location.href=g;break;case"translateXY":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),doTranslateXY(f,g);break;case"append":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$("#"+f).append(g);break;case"parsehtml":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),parseHtml(f,g);break;case"show":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$(f).show();break;case"play":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$("#"+f)[0].play();break;case"pause":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$("#"+f)[0].pause();break;case"autoplay":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$("#"+f)[0].autoplay=g;break;case"volume":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$("#"+f)[0].volume=g;break;case"loop":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$("#"+f)[0].loop=g;break;case"hide":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$(f).hide(g);break;case"draggable":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),$(f).draggable();break;case"bind":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),setBind(f,g);break;case"template":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),setTemplate(f,g);break;case"syncvars":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),setSyncvars(f,g);break;case"update":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),doUpdate(f,g);break;case"add":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),addToDiv(f,g);break;case"put":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),putMsg(f,g);break;case"remove":remove(f);break;case"terminate":console.log("terminate command"),doTerminate(f);break;case"setcss":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),setCSS(g);break;case"setstyle":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),setStyle(g);break;case"setscript":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),setScript(f,g);break;case"removestyle":g=b.substring(b.substring(b.indexOf("("))+1,b.indexOf(")")),removeStyle(g);break;case"sdiv":g=b.substring(d+2),d=g.indexOf("($end$)"),d!=-1&&(g=g.substring(0,d)),setDivProperty(f,g)}d=b.indexOf("($end$)"),d!=-1?(b=b.substring(d+7),d=b.indexOf("(")):d=-1}};return self};